const t=(e="function",t=>typeof t===e);var e;const s="nothing",n=e=>t(e)?n(e()):e,c=e=>t(e)&&"type"in e,o=(e,s)=>e&&t(e[s]),r=t=>(t=>null==t)(t)||((t,e)=>c(e)&&e.type===t)(s,t),a=t=>r(t)?u():i(t),i=t=>{const e=()=>t;return e.type=typeof t,e.or=e=>t,e.map=e=>a(e(t)),e.chain=e=>e(t),e.filter=e=>e(t)?i(t):u(),e},u=()=>new Proxy((()=>{}),{get:(t,e)=>{switch(e){case"type":return s;case"toString":return()=>"";case"or":return t=>t;case"chain":return t=>t();default:return()=>u()}}});let h;const l=e=>t(e)&&o(e,"set"),f=e=>l(e)||(e=>t(e)&&o(e,"run")&&"effects"in e)(e),d=e=>{const s=()=>(h&&s.effects.add(h),e);return s.effects=new Set,s.set=r=>{const a=e;e=t(r)&&!f(r)?(t=>c(t)&&o(t,"map"))(e)?e.map(r):r(e):r,!Object.is(n(e),n(a))&&(t=>{for(const e of t)e.run()})(s.effects)},s},p=e=>{const s=new Map,n=()=>{const c=h;h=n;const o=e(((t,e)=>{!s.has(t)&&s.set(t,new Set),s.get(t)?.add(e)}));for(const t of s.values()){for(const e of t)e();t.clear()}h=c,t(o)&&queueMicrotask(o)};n.run=()=>n(),n.targets=s,n()},g="context-request";class b extends Event{context;callback;subscribe;constructor(t,e,s=!1){super(g,{bubbles:!0,composed:!0}),this.context=t,this.callback=e,this.subscribe=s}}class m extends HTMLElement{static consumedContexts;static providedContexts;static define(t,e=customElements){try{e.get(t)||e.define(t,this)}catch(t){console.error(t)}}attributeMap={};#t=new Map;attributeChangedCallback(e,s,n){if(n===s)return;const c=this.attributeMap[e],o=a(n);this.set(e,t(c)?o.map((t=>c(t,this,s))):o)}connectedCallback(){const e=this.constructor,s=e.consumedContexts||[];for(const t of s)this.set(String(t),void 0);setTimeout((()=>{for(const t of s)this.dispatchEvent(new b(t,(e=>this.set(String(t),e))))}));const n=e.providedContexts||[];n.length&&this.addEventListener(g,(e=>{const{context:s,callback:c}=e;n.includes(s)&&t(c)&&(e.stopPropagation(),c(this.#t.get(String(s))))}))}has(t){return this.#t.has(t)}get(t){return n(this.#t.get(t))}set(t,e,s=!0){if(this.#t.has(t)){if(s){const s=this.#t.get(t);l(s)&&s.set(e)}}else this.#t.set(t,f(e)?e:d(e))}delete(t){return this.#t.delete(t)}async pass(e,s,n=customElements){if(await n.whenDefined(e.localName),!o(e,"set"))throw new TypeError("Expected UIElement");for(const[n,c]of Object.entries(s))e.set(n,f(c)?c:t(c)?d(c):this.#t.get(c))}signal(t){return this.#t.get(t)}}export{m as default,p as effect};